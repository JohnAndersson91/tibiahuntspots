<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tibia Hunt Spots</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<style>
  body { background:#1e1e1e; color:#f0f0f0; font-family:sans-serif; padding:20px; }
  table { width:100%; border-collapse: collapse; margin-top:20px; }
  th, td { border:1px solid #444; padding:8px; text-align:left; }
  th { cursor:pointer; user-select:none; }
  th .arrow { font-size:0.8em; margin-left:5px; color:#ffcc00; }
  #imageModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
    background:rgba(0,0,0,0.8); justify-content:center; align-items:center; }
  #imageModal img { max-width:90%; max-height:90%; }
  img.thumb { max-width:50px; max-height:50px; margin:2px; cursor:pointer; }
  #imagePreview img { max-width:50px; max-height:50px; margin:2px; }
  #addSpotForm { margin-top:20px; display:flex; flex-direction:column; gap:5px; }
  input, button, select { padding:5px; border-radius:4px; border:none; }
  button { cursor:pointer; background:#555; color:#fff; }
  #backupBtn, #loadBackupBtn { margin-top:10px; }
  .highlight { background:#333366; }
</style>
</head>
<body>

<h1>Tibia Hunt Spots</h1>

<!-- Section Selector -->
<select id="sectionSelector">
  <option value="All">All Classes</option>
  <option value="Knight">Knight</option>
  <option value="Paladin">Paladin</option>
  <option value="Mages">Mages</option>
  <option value="Monk">Monk</option>
  <option value="Duo">Duo</option>
</select>

<!-- Spots Table -->
<table>
  <thead>
    <tr>
      <th>Spot</th>
      <th id="levelHeader">Level <span class="arrow"></span></th>
      <th id="expHeader">Raw Exp <span class="arrow"></span></th>
      <th id="profitHeader">Profit <span class="arrow"></span></th>
      <th>Images</th>
    </tr>
  </thead>
  <tbody id="spotsBody"></tbody>
</table>

<!-- Image Modal -->
<div id="imageModal">
  <img id="modalImg" src="">
</div>

<!-- Password -->
<div id="loginDiv">
  <input type="password" id="password" placeholder="Enter password to manage spots">
  <button onclick="checkPassword()">Login</button>
</div>

<!-- Add Spot Form -->
<div id="formDiv" style="display:none;">
  <form id="addSpotForm">
    <input type="text" id="spotName" placeholder="Spot Name" required>
    <select id="sectionSelect" required>
      <option value="" disabled selected>Select Class</option>
      <option value="Knight">Knight</option>
      <option value="Paladin">Paladin</option>
      <option value="Mages">Mages</option>
      <option value="Monk">Monk</option>
      <option value="Duo">Duo</option>
    </select>
    <input type="number" id="level" placeholder="Level" required>
    <input type="number" id="exp" placeholder="Raw Exp" required>
    <input type="number" id="profit" placeholder="Profit" required>
    <input type="file" id="images" multiple accept="image/*">
    <div id="imagePreview"></div>
    <button type="submit">Add Spot</button>
  </form>

  <!-- Backup and Load -->
  <button id="backupBtn">Save Backup</button>
  <input type="file" id="loadBackupInput" accept=".json">
  <button id="loadBackupBtn">Load Backup</button>
</div>

<script>
/* FIREBASE INIT */
const firebaseConfig = {
  apiKey: "AIzaSyBkmHIc3xwSz4zoNX1R3OxCPfcoSYUyfB4",
  authDomain: "tibiahuntspots.firebaseapp.com",
  databaseURL: "https://tibiahuntspots-default-rtdb.firebaseio.com/",
  projectId: "tibiahuntspots",
  storageBucket: "tibiahuntspots.appspot.com",
  messagingSenderId: "1095180317117",
  appId: "1:1095180317117:web:57bd4d2cf8b22edec4a2d4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const spotsRef = db.ref('spots');

let spots = {};
let currentSection = 'All';
let sortState = {level:null, exp:null, profit:null};
const PASSWORD = "willchange321"; // change this

const tbody = document.getElementById("spotsBody");

/* LOAD FROM FIREBASE */
spotsRef.on("value", snapshot => {
  spots = snapshot.val() || {};
  renderFirebaseTable();
});

/* RENDER TABLE */
function renderFirebaseTable(sortedKeys = null) {
  tbody.innerHTML = "";
  let keys = Object.keys(spots);
  if (sortedKeys) keys = sortedKeys;

  keys.forEach(key => {
    const s = spots[key];
    if(currentSection !== 'All' && s.section !== currentSection) return;

    const tr = document.createElement("tr");
    const imagesHTML = (s.images || []).map(i => `<img src="${i}" class="thumb" onclick="showImage('${i}')">`).join("");

    tr.innerHTML = `
      <td>${s.spot}</td>
      <td>${s.level}</td>
      <td>${s.exp}</td>
      <td>${s.profit}</td>
      <td>${imagesHTML}</td>
    `;

    tr.classList.add("highlight");
    setTimeout(() => tr.classList.remove("highlight"), 2000);

    tbody.appendChild(tr);
  });
}

/* IMAGE MODAL */
function showImage(src) {
  const modal = document.getElementById("imageModal");
  document.getElementById("modalImg").src = src;
  modal.style.display = "flex";
}
document.getElementById("imageModal").onclick = function(){ this.style.display="none"; }

/* SORTING */
function sortTable(key){
  if(sortState[key] === null) sortState[key] = true;
  else sortState[key] = !sortState[key];

  let sortedKeys = Object.keys(spots).sort((a,b)=>{
    const A = spots[a][key];
    const B = spots[b][key];
    return sortState[key] ? A - B : B - A;
  });

  ['level','exp','profit'].forEach(h=>{
    const arrowEl = document.querySelector("#"+h+"Header .arrow");
    arrowEl.textContent = "";
    if(h===key) arrowEl.textContent = sortState[key] ? "↑":"↓";
  });

  renderFirebaseTable(sortedKeys);
}
['level','exp','profit'].forEach(k=>document.getElementById(k+'Header').onclick=()=>sortTable(k));

/* PASSWORD LOGIN */
function checkPassword() {
  if(document.getElementById("password").value === PASSWORD){
    document.getElementById("formDiv").style.display = "block";
    document.getElementById("loginDiv").style.display = "none";
  } else {
    alert("Incorrect password");
  }
}

/* IMAGE PREVIEW */
document.getElementById("images").addEventListener("change", function(){
  const preview = document.getElementById("imagePreview");
  preview.innerHTML = "";
  Array.from(this.files).forEach(file=>{
    const reader = new FileReader();
    reader.onload = function(e){
      const img = document.createElement("img");
      img.src = e.target.result;
      preview.appendChild(img);
    }
    reader.readAsDataURL(file);
  });
});

/* ADD SPOT TO FIREBASE */
document.getElementById("addSpotForm").addEventListener("submit", function(e){
  e.preventDefault();
  const files = document.getElementById("images").files;
  const imagesArray = Array.from(files).map(f => URL.createObjectURL(f));

  const newSpot = {
    spot: document.getElementById("spotName").value,
    section: document.getElementById("sectionSelect").value,
    level: Number(document.getElementById("level").value),
    exp: Number(document.getElementById("exp").value),
    profit: Number(document.getElementById("profit").value),
    images: imagesArray
  };

  spotsRef.push(newSpot);
  this.reset();
  document.getElementById("imagePreview").innerHTML = "";
});

/* BACKUP */
document.getElementById("backupBtn").addEventListener("click", ()=>{
  const dataStr = JSON.stringify(spots, null, 2);
  const blob = new Blob([dataStr], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "tibia_hunt_spots_backup.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

/* LOAD BACKUP */
document.getElementById("loadBackupBtn").addEventListener("click", ()=>{
  const fileInput = document.getElementById("loadBackupInput");
  if(fileInput.files.length === 0){
    alert("Please select a JSON backup file first.");
    return;
  }
  const file = fileInput.files[0];
  const reader = new FileReader();
  reader.onload = function(e){
    try {
      const loadedSpots = JSON.parse(e.target.result);
      spotsRef.set(loadedSpots);
      alert("Backup loaded successfully!");
    } catch(err){
      alert("Error reading backup: " + err);
    }
  };
  reader.readAsText(file);
});

/* FILTER BY SECTION */
document.getElementById("sectionSelector").addEventListener("change", (e)=>{
  currentSection = e.target.value;
  renderFirebaseTable();
});
</script>

</body>
</html>
